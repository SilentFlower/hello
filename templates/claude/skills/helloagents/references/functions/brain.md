# ~brain 命令 - 头脑风暴

本模块定义头脑风暴命令的执行规则，将想法转化为可执行的方案包。

---

## 命令说明

```yaml
命令: ~brain [<主题描述>]
类型: 场景确认类（简化入口）
功能: 协作式头脑风暴，通过一问一答澄清需求，探索方案，生成方案包
触发: 用户输入包含 ~brain
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~brain 模式适配规则:
1. 本命令为场景确认类，但采用简化入口（无轻量评估确认步骤）
2. 用户输入 ~brain 后直接进入上下文收集和需求澄清流程
3. 输出方案包后保持待命状态
4. 不设置 WORKFLOW_MODE，保持 INTERACTIVE 默认模式
</mode_adaptation>

---

## 执行流程

### 步骤1: 上下文收集

```yaml
执行内容:
  - 扫描项目结构（目录、主要文件）
  - 查看相关文件（如用户提供了主题描述，定位相关代码）
  - 检查最近提交（git log -5）

输出格式:
  🔵【HelloAGENTS】- ~brain 上下文收集
  {项目结构摘要、相关文件、最近提交}
  🔄 下一步: 开始需求澄清
```

### 步骤2: 需求澄清

```yaml
执行内容:
  - 一次一问，每条消息只问一个问题
  - 优先使用多选题（2-4个选项），开放式问题为辅
  - 聚焦理解：目的、约束、成功标准
  - 持续澄清直到充分理解需求（无轮数限制）

输出格式:
  ❓【HelloAGENTS】- ~brain 需求澄清
  {单个问题}

  选项:
    A. {选项1}（推荐）
    B. {选项2}
    C. {选项3}

  🔄 下一步: 请选择或输入

问题设计原则:
  - 从宏观到具体：先确定整体方向，再深入细节
  - 选项互斥：每个选项代表不同的实现路径
  - 推荐标注：在推荐选项后标注"（推荐）"并说明理由
```

### 步骤3: 方案探索

```yaml
执行内容:
  - 提出 2-3 个不同方案
  - 说明每个方案的权衡（优点/缺点）
  - 给出推荐方案及理由

输出格式:
  💡【HelloAGENTS】- ~brain 方案探索

  **方案对比:**

  | 方案 | 描述 | 优点 | 缺点 |
  |------|------|------|------|
  | A（推荐） | ... | ... | ... |
  | B | ... | ... | ... |
  | C | ... | ... | ... |

  **推荐理由:** {为什么推荐方案A}

  🔄 下一步: 请选择方案
```

### 步骤4: 设计呈现

```yaml
执行内容:
  - 将设计分段呈现（每段 200-300 字）
  - 每段完成后询问确认
  - 覆盖内容：架构、组件、数据流、错误处理、测试策略
  - 如用户提出调整，回退修改后重新呈现

输出格式:
  🔵【HelloAGENTS】- ~brain 设计呈现 (N/M)

  ### {当前段落标题}

  {当前段落内容，200-300字}

  🔄 下一步: 确认继续 / 需要调整

设计段落划分（参考）:
  1. 整体架构与模块划分
  2. 核心组件设计
  3. 数据流与接口定义
  4. 错误处理与边界情况
  5. 测试策略与验收标准
```

### 步骤5: 方案包生成

> 📌 规则引用: 方案包格式与 templates.md 保持一致，确保 ~exec 可正常执行

```yaml
执行内容:
  - 创建方案包目录: plan/YYYYMMDDHHMM_<topic>/
  - 生成 proposal.md（按标准格式，融合头脑风暴内容）
  - 生成 tasks.md（按标准格式，包含完整任务列表）

proposal.md 结构（与 templates.md 一致）:
  元信息（必须）:
    <!--
    @name: {方案包名称}
    @created: {YYYY-MM-DD HH:MM}
    @type: implementation | overview
    @source: brain
    -->

  1. 需求（必须）:
    - 1.1 背景: 需求澄清过程中收集的背景信息
    - 1.2 目标: 用户想要实现的目标
    - 1.3 约束条件: 限制和要求
    - 1.4 验收标准: 如何验证完成

  2. 方案（必须）:
    - 2.1 方案对比: 方案探索阶段的对比表（~brain 特色）
    - 2.2 选中方案: 最终选择的方案及理由
    - 2.3 影响范围: 涉及的模块/文件
    - 2.4 风险评估: 潜在风险

  3. 技术设计（必须，~brain 设计呈现内容）:
    - 3.1 架构设计: 整体架构与模块划分
    - 3.2 核心组件: 组件设计与职责
    - 3.3 数据流与接口: 接口定义与数据流向
    - 3.4 错误处理: 边界情况与异常处理

  4. 核心场景（可选）

  5. 技术决策（可选）

  6. 后续建议（~brain 特色）:
    - 实现注意事项
    - 测试策略建议

tasks.md 结构（与 templates.md 一致）:
  元数据头部（必须）:
    <!--
    @feature: {功能名称}
    @created: {YYYY-MM-DD HH:MM}
    @status: pending
    @mode: standard | lightweight
    @source: brain
    -->

  进度概览（必须）:
    | 状态 | 数量 |
    |------|------|
    | [√] 完成 | 0 |
    | [X] 失败 | 0 |
    | [-] 跳过 | 0 |
    | [ ] 待执行 | N |

  任务列表（必须）:
    按阶段/模块分组，从设计呈现内容提取具体任务

  执行日志（必须）:
    初始为空，执行时填充

  执行备注（必须）:
    记录头脑风暴过程中的特殊说明

输出格式:
  ✅【HelloAGENTS】- ~brain 完成

  📁 文件变更:
    - plan/YYYYMMDDHHMM_<topic>/proposal.md
    - plan/YYYYMMDDHHMM_<topic>/tasks.md

  🔄 下一步: 使用 ~exec 执行方案包
```

### 步骤6: CHANGELOG 更新

```yaml
执行内容:
  - 记录到 CHANGELOG.md "方案设计" 分类
  - 格式: "- 完成 <topic> 头脑风暴设计"

目录创建: 按 G1 "目录/文件自动创建规则" 执行
```

---

## 核心原则

```yaml
单次单问: 每条消息只问一个问题，避免信息过载
多选优先: 能用选项就不用开放式问题，降低用户认知负担
YAGNI: 设计中剔除非必要功能，保持精简
分段验证: 设计分段呈现，逐段确认，及时发现偏差
灵活回退: 发现问题时可回退重新澄清，不强行推进
```

---

## 用户选择处理

### 场景: 需求澄清问答

```yaml
内容要素:
  - 当前问题（单个）
  - 选项列表（2-4个，含推荐标注）

选项: 用户选择字母或自由输入

处理规则:
  有效选择: 记录答案，继续下一个问题或进入方案探索
  自由输入: 解析用户意图，必要时追问确认
  "跳过/不确定": 记录为待定，继续流程
```

### 场景: 方案选择

```yaml
内容要素:
  - 方案对比表
  - 推荐理由

选项: A/B/C 或自定义方案

处理规则:
  选择方案: 进入设计呈现阶段
  自定义方案: 根据用户描述调整方案，再次确认
```

### 场景: 设计段落确认

```yaml
内容要素:
  - 当前段落内容
  - 段落进度（N/M）

选项:
  确认继续: 进入下一段落
  需要调整: 用户说明调整需求，修改后重新呈现

处理规则:
  全部段落确认: 进入方案包生成
  用户取消: 按 G6 状态重置协议执行
```
